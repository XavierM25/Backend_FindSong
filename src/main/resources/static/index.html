<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FindSong - Reconocedor de Música</title>
    <!-- Añadir Font Awesome para iconos de redes sociales -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f9f9f9;
        color: #333;
      }

      .container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-top: 20px;
      }

      h1 {
        color: #3498db;
        text-align: center;
        margin-bottom: 30px;
      }

      button {
        background-color: #3498db;
        border: none;
        color: white;
        padding: 12px 30px;
        text-align: center;
        font-size: 16px;
        margin: 10px 0;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 100%;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
        font-size: 16px;
      }

      .recording {
        background-color: #fef5f5;
        border-left: 4px solid #e74c3c;
        color: #e74c3c;
      }

      .listening {
        background-color: #f0f9ff;
        border-left: 4px solid #3498db;
        color: #3498db;
      }

      .recognized {
        background-color: #efffef;
        border-left: 4px solid #2ecc71;
        color: #2ecc71;
      }

      #result {
        margin-top: 30px;
        display: none;
      }

      .song-info {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .song-cover {
        width: 180px;
        height: 180px;
        border-radius: 5px;
        object-fit: cover;
        margin-bottom: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .song-title {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0 5px;
        text-align: center;
      }

      .song-artist {
        font-size: 18px;
        color: #666;
        margin-bottom: 20px;
        text-align: center;
      }

      .song-details {
        margin-top: 15px;
        width: 100%;
      }

      .song-details div {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
      }

      .song-details .label {
        font-weight: bold;
        color: #555;
      }

      .song-links {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 15px;
      }

      .song-links a {
        display: inline-block;
        padding: 10px 15px;
        background-color: #f8f8f8;
        border-radius: 5px;
        text-decoration: none;
        color: #333;
        font-weight: bold;
        border: 1px solid #ddd;
        transition: all 0.3s;
      }

      .song-links a:hover {
        background-color: #eee;
        transform: translateY(-2px);
      }

      .loader {
        display: none;
        text-align: center;
        margin: 20px 0;
      }

      .loader div {
        width: 10px;
        height: 10px;
        background-color: #3498db;
        border-radius: 50%;
        display: inline-block;
        margin: 0 3px;
        animation: bounce 1.5s infinite ease-in-out both;
      }

      .loader div:nth-child(1) {
        animation-delay: -0.3s;
      }
      .loader div:nth-child(2) {
        animation-delay: -0.15s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .error {
        background-color: #fff2f2;
        border-left: 4px solid #e74c3c;
        padding: 15px;
        margin: 20px 0;
        color: #e74c3c;
        border-radius: 5px;
      }

      /* Estilos para la información del artista */
      .artist-section {
        display: flex;
        margin: 20px 0;
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
      }

      .artist-image {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
      }

      .artist-details {
        flex: 1;
      }

      #artistBio {
        font-size: 14px;
        color: #555;
        margin-bottom: 15px;
        max-height: 120px;
        overflow-y: auto;
        line-height: 1.5;
        text-align: justify;
        position: relative;
        transition: max-height 0.5s ease;
      }

      #artistBio.expanded {
        max-height: 500px;
      }

      .bio-toggle {
        display: inline-block;
        color: #3498db;
        cursor: pointer;
        text-decoration: underline;
        margin-top: 5px;
        font-size: 13px;
      }

      .artist-stats {
        margin-bottom: 15px;
      }

      /* Nuevos estilos para redes sociales */
      .social-links {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
      }

      .social-links a {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        text-decoration: none;
        color: white;
        font-size: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .social-links a:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      }

      .social-links .facebook {
        background-color: #3b5998;
      }

      .social-links .twitter {
        background-color: #1da1f2;
      }

      .social-links .instagram {
        background: linear-gradient(
          45deg,
          #405de6,
          #5851db,
          #833ab4,
          #c13584,
          #e1306c,
          #fd1d1d
        );
      }

      .social-links .youtube {
        background-color: #ff0000;
      }

      .social-links .tiktok {
        background-color: #000000;
      }

      .social-links .spotify {
        background-color: #1db954;
      }

      .social-links .soundcloud {
        background-color: #ff7700;
      }

      .social-links .apple {
        background-color: #a2aaad;
      }

      .social-links .deezer {
        background-color: #00c7f2;
      }

      .social-links .amazon {
        background-color: #ff9900;
      }

      .social-links .pinterest {
        background-color: #e60023;
      }

      .social-links .linkedin {
        background-color: #0077b5;
      }

      .social-links .default {
        background-color: #777777;
      }

      /* Estilos para las canciones del álbum */
      .tracks-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        max-height: 300px;
        overflow-y: auto;
      }

      .tracks-list li {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
      }

      .tracks-list li:hover {
        background-color: #f5f5f5;
      }

      .album-header {
        background-color: #f0f0f0;
        font-weight: bold;
        padding: 10px;
        margin-top: 10px;
      }

      .track-number {
        color: #999;
        margin-right: 10px;
        min-width: 25px;
      }

      .track-title {
        flex: 1;
      }

      .track-duration {
        color: #888;
      }

      .current-track {
        background-color: #e8f4fd;
        font-weight: bold;
      }

      .play-preview {
        background: none;
        border: none;
        color: #3498db;
        cursor: pointer;
        padding: 0 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>FindSong</h1>
      <p>
        Pulsa el botón para comenzar a escuchar música y averiguar qué canción
        está sonando.
      </p>

      <button id="startButton">Activar micrófono</button>
      <button id="stopButton" disabled>Detener grabación</button>

      <div id="statusMessage" class="status"></div>

      <div id="loader" class="loader">
        <div></div>
        <div></div>
        <div></div>
      </div>

      <div id="error" class="error" style="display: none"></div>

      <div id="result">
        <div class="song-info">
          <img
            id="coverArt"
            class="song-cover"
            src=""
            alt="Portada del álbum"
          />
          <div class="song-title" id="songTitle"></div>
          <div class="song-artist" id="songArtist"></div>
        </div>

        <div class="song-details">
          <div>
            <span class="label">Álbum:</span>
            <span id="songAlbum"></span>
          </div>
          <div>
            <span class="label">Lanzamiento:</span>
            <span id="songReleaseDate"></span>
          </div>
          <div>
            <span class="label">Género:</span>
            <span id="songGenre"></span>
          </div>
        </div>

        <!-- Sección: Información del artista -->
        <div id="artistInfo" style="display: none">
          <h3>Sobre el artista</h3>
          <div class="artist-section">
            <img
              id="artistImage"
              class="artist-image"
              src=""
              alt="Foto del artista"
            />
            <div class="artist-details">
              <div id="artistBio"></div>
              <div class="artist-stats">
                <div>
                  <span class="label">Seguidores:</span>
                  <span id="artistFollowers"></span>
                </div>
              </div>
              <h4>Redes sociales</h4>
              <div class="social-links" id="artistLinks"></div>
            </div>
          </div>
        </div>

        <!-- Sección: Canciones del álbum -->
        <div id="albumTracks" style="display: none">
          <h3>Canciones del álbum</h3>
          <div class="album-tracks-container">
            <ul id="tracksList" class="tracks-list"></ul>
          </div>
        </div>

        <div class="song-links">
          <a id="spotifyLink" href="#" target="_blank">Abrir en Spotify</a>
          <a id="appleMusicLink" href="#" target="_blank"
            >Abrir en Apple Music</a
          >
          <a id="previewLink" href="#" target="_blank">Escuchar Preview</a>
        </div>
      </div>
    </div>

    <script>
      // Función global para reproducir preview de canciones
      function playPreview(url) {
        const audio = new Audio(url);
        audio.play();
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Elementos del DOM
        const startButton = document.getElementById("startButton");
        const stopButton = document.getElementById("stopButton");
        const statusMessage = document.getElementById("statusMessage");
        const loader = document.getElementById("loader");
        const error = document.getElementById("error");
        const result = document.getElementById("result");

        // Variables para la grabación
        let mediaRecorder;
        let audioChunks = [];
        let recordingTimeout;

        // Duración máxima de grabación (ms)
        const MAX_RECORDING_TIME = 10000;

        // Event listeners
        startButton.addEventListener("click", startRecording);
        stopButton.addEventListener("click", stopRecording);

        // Función para iniciar la grabación
        function startRecording() {
          // Reseteamos el estado
          resetUI();

          // Solicitamos acceso al micrófono
          navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then((stream) => {
              // Cambiamos el estado de los botones
              startButton.disabled = true;
              stopButton.disabled = false;

              // Mostramos el estado
              statusMessage.textContent =
                "Escuchando música... Mantén el micrófono cerca de la fuente de sonido";
              statusMessage.className = "status listening";

              // Configuramos el MediaRecorder
              mediaRecorder = new MediaRecorder(stream);

              // Cuando hay datos disponibles, los guardamos
              mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
              };

              // Cuando la grabación termina, enviamos los datos
              mediaRecorder.onstop = () => {
                // Creamos un Blob con los datos de audio
                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });

                // Enviamos el audio al servidor
                sendAudioToServer(audioBlob);

                // Detenemos todas las pistas del stream
                stream.getTracks().forEach((track) => track.stop());
              };

              // Empezamos a grabar
              audioChunks = [];
              mediaRecorder.start();

              // Establecemos un timeout para detener la grabación después de un tiempo
              recordingTimeout = setTimeout(() => {
                if (mediaRecorder.state === "recording") {
                  stopRecording();
                }
              }, MAX_RECORDING_TIME);
            })
            .catch((err) => {
              console.error("Error al acceder al micrófono:", err);
              showError(
                "No se pudo acceder al micrófono. Por favor, asegúrate de dar permiso a la aplicación para usar el micrófono."
              );
            });
        }

        // Función para detener la grabación
        function stopRecording() {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            clearTimeout(recordingTimeout);
            mediaRecorder.stop();

            // Actualizamos la UI
            statusMessage.textContent = "Procesando audio...";
            loader.style.display = "block";
            startButton.disabled = true;
            stopButton.disabled = true;
          }
        }

        // Función para enviar el audio al servidor
        function sendAudioToServer(audioBlob) {
          // Creamos un FormData para enviar el archivo
          const formData = new FormData();
          formData.append("audio", audioBlob, "recording.wav");
          formData.append("duration", "10"); // Duración en segundos

          // Ocultamos el mensaje de estado y mostramos el loader
          statusMessage.style.display = "none";
          loader.style.display = "block";

          // Mostrar mensaje de espera
          document.getElementById("statusMessage").textContent =
            "Analizando audio... Esto puede tardar hasta 30 segundos";
          document.getElementById("statusMessage").style.display = "block";

          // Enviamos la petición con un timeout largo
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 segundos de timeout

          fetch("/api/audio-recognition/identify", {
            method: "POST",
            body: formData,
            signal: controller.signal,
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Respuesta completa del servidor:", data);
              loader.style.display = "none";
              handleRecognitionResult(data);
            })
            .catch((err) => {
              console.error("Error al enviar audio:", err);
              if (err.name === "AbortError") {
                showError(
                  "La solicitud ha tardado demasiado tiempo. Inténtalo de nuevo con un fragmento de audio más corto."
                );
              } else {
                showError("Error al procesar la solicitud: " + err.message);
              }
            })
            .finally(() => {
              clearTimeout(timeoutId);
              loader.style.display = "none";
              startButton.disabled = false;
            });
        }

        // Función para obtener icono correspondiente a la plataforma
        function getSocialIcon(platform) {
          const platformLower = platform.toLowerCase();
          const iconMap = {
            spotify: '<i class="fab fa-spotify"></i>',
            instagram: '<i class="fab fa-instagram"></i>',
            facebook: '<i class="fab fa-facebook-f"></i>',
            twitter: '<i class="fab fa-twitter"></i>',
            x: '<i class="fab fa-twitter"></i>',
            youtube: '<i class="fab fa-youtube"></i>',
            tiktok: '<i class="fab fa-tiktok"></i>',
            soundcloud: '<i class="fab fa-soundcloud"></i>',
            "apple music": '<i class="fab fa-apple"></i>',
            "amazon music": '<i class="fab fa-amazon"></i>',
            pinterest: '<i class="fab fa-pinterest-p"></i>',
            linkedin: '<i class="fab fa-linkedin-in"></i>',
            deezer: '<i class="fas fa-music"></i>',
          };

          return iconMap[platformLower] || '<i class="fas fa-link"></i>';
        }

        // Función para manejar el resultado del reconocimiento
        function handleRecognitionResult(data) {
          if (data.success) {
            // Mostramos los datos de la canción de Shazam
            const shazamInfo = data.shazamInfo;
            const spotifyInfo = data.spotifyInfo;

            // Actualizar información básica de la canción
            document.getElementById("songTitle").textContent =
              shazamInfo.title || "Desconocido";
            document.getElementById("songArtist").textContent =
              shazamInfo.artist || "Artista desconocido";
            document.getElementById("songAlbum").textContent =
              shazamInfo.album || "Desconocido";
            document.getElementById("songReleaseDate").textContent =
              shazamInfo.releaseDate || "Desconocido";
            document.getElementById("songGenre").textContent =
              shazamInfo.genres && shazamInfo.genres.length
                ? shazamInfo.genres.join(", ")
                : "Desconocido";

            // Actualizamos la imagen de portada
            const coverArt = document.getElementById("coverArt");
            if (shazamInfo.coverArtUrl) {
              coverArt.src = shazamInfo.coverArtUrl;
              coverArt.style.display = "block";
            } else {
              coverArt.style.display = "none";
            }

            // Actualizamos los enlaces
            const spotifyLink = document.getElementById("spotifyLink");
            if (shazamInfo.spotifyId) {
              spotifyLink.href = `https://open.spotify.com/track/${shazamInfo.spotifyId
                .split(":")
                .pop()}`;
              spotifyLink.style.display = "inline-block";
            } else {
              spotifyLink.style.display = "none";
            }

            const appleMusicLink = document.getElementById("appleMusicLink");
            if (shazamInfo.appleMusicId) {
              appleMusicLink.href = `https://music.apple.com/us/album/${shazamInfo.appleMusicId}`;
              appleMusicLink.style.display = "inline-block";
            } else {
              appleMusicLink.style.display = "none";
            }

            const previewLink = document.getElementById("previewLink");
            if (shazamInfo.previewUrl) {
              previewLink.href = shazamInfo.previewUrl;
              previewLink.style.display = "inline-block";
            } else {
              previewLink.style.display = "none";
            }

            // Mostrar información del artista de Spotify si está disponible
            if (spotifyInfo) {
              const artistInfo = document.getElementById("artistInfo");
              artistInfo.style.display = "block";

              // Actualizar imagen del artista
              const artistImage = document.getElementById("artistImage");
              if (spotifyInfo.images && spotifyInfo.images.length > 0) {
                artistImage.src = spotifyInfo.images[0].url;
              }

              // Actualizar biografía y estadísticas
              const artistBioElement = document.getElementById("artistBio");
              artistBioElement.textContent =
                spotifyInfo.bio || "No hay biografía disponible";

              // Añadir botón para expandir/contraer la bio si es larga
              if (spotifyInfo.bio && spotifyInfo.bio.length > 200) {
                const bioToggle = document.createElement("span");
                bioToggle.className = "bio-toggle";
                bioToggle.textContent = "Mostrar más";
                bioToggle.onclick = function () {
                  if (artistBioElement.classList.contains("expanded")) {
                    artistBioElement.classList.remove("expanded");
                    bioToggle.textContent = "Mostrar más";
                  } else {
                    artistBioElement.classList.add("expanded");
                    bioToggle.textContent = "Mostrar menos";
                  }
                };

                // Añadir el botón después de la bio
                artistBioElement.parentNode.insertBefore(
                  bioToggle,
                  artistBioElement.nextSibling
                );
              }

              document.getElementById("artistFollowers").textContent =
                spotifyInfo.followers?.toLocaleString() || "0";

              // Actualizar enlaces sociales con íconos
              const artistLinks = document.getElementById("artistLinks");
              artistLinks.innerHTML = "";

              // Verificar si hay un enlace a Spotify
              if (spotifyInfo.spotifyUrl) {
                const spotifyLink = document.createElement("a");
                spotifyLink.href = spotifyInfo.spotifyUrl;
                spotifyLink.target = "_blank";
                spotifyLink.rel = "noopener noreferrer";
                spotifyLink.className = "spotify";
                spotifyLink.title = "Spotify";
                spotifyLink.innerHTML = '<i class="fab fa-spotify"></i>';
                artistLinks.appendChild(spotifyLink);
              }

              // Mostrar álbumes si están disponibles
              if (spotifyInfo.albums && spotifyInfo.albums.length > 0) {
                const albumTracks = document.getElementById("albumTracks");
                albumTracks.style.display = "block";

                const tracksList = document.getElementById("tracksList");
                tracksList.innerHTML = "";

                spotifyInfo.albums.forEach((album) => {
                  const albumHeader = document.createElement("li");
                  albumHeader.className = "album-header";
                  albumHeader.innerHTML = `<strong>${album.name}</strong> (${album.releaseDate})`;
                  tracksList.appendChild(albumHeader);

                  if (album.tracks) {
                    album.tracks.forEach((track, index) => {
                      const trackItem = document.createElement("li");
                      const isCurrentTrack =
                        track.name.toLowerCase() ===
                        shazamInfo.title.toLowerCase();
                      if (isCurrentTrack) {
                        trackItem.className = "current-track";
                      }

                      trackItem.innerHTML = `
                        <span class="track-number">${index + 1}</span>
                        <span class="track-title">${track.name}${
                        isCurrentTrack ? " <small>(Canción actual)</small>" : ""
                      }</span>
                        <span class="track-duration">${formatDuration(
                          track.duration
                        )}</span>
                        ${
                          track.previewUrl
                            ? `<button class="play-preview" onclick="playPreview('${track.previewUrl}')">▶</button>`
                            : ""
                        }
                      `;
                      tracksList.appendChild(trackItem);
                    });
                  }
                });
              }
            }

            // Mostrar el resultado
            document.getElementById("result").style.display = "block";
            document.getElementById("statusMessage").className =
              "status recognized";
            document.getElementById("statusMessage").textContent =
              "¡Canción reconocida!";
            document.getElementById("statusMessage").style.display = "block";
          } else {
            showError(
              data.message ||
                "No se pudo reconocer la canción. Intenta de nuevo con mejor calidad de audio."
            );
          }
        }

        // Función auxiliar para formatear la duración
        function formatDuration(ms) {
          const minutes = Math.floor(ms / 60000);
          const seconds = Math.floor((ms % 60000) / 1000);
          return `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        // Función para mostrar errores
        function showError(message) {
          error.textContent = message;
          error.style.display = "block";
          result.style.display = "none";
          statusMessage.style.display = "none";
          startButton.disabled = false;
          stopButton.disabled = true;
        }

        // Función para resetear la UI
        function resetUI() {
          error.style.display = "none";
          result.style.display = "none";
          loader.style.display = "none";
          statusMessage.textContent = "";
          statusMessage.className = "status";
          statusMessage.style.display = "block";
        }
      });
    </script>
  </body>
</html>
